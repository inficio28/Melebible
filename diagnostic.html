<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Connexion Supabase - Mots M√™l√©s</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1A1423 0%, #2D1B4E 100%);
            color: #FFF8F0;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 107, 53, 0.3);
            border-radius: 20px;
            padding: 2rem;
        }

        h1 {
            color: #FF6B35;
            margin-bottom: 2rem;
            text-align: center;
        }

        .test-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #FF6B35;
        }

        .test-section h2 {
            color: #F7931E;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        .config-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-family: monospace;
        }

        .config-label {
            color: #06D6A0;
            font-weight: bold;
            display: block;
            margin-bottom: 0.5rem;
        }

        .config-value {
            color: #FFF8F0;
            word-break: break-all;
        }

        .status {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 1rem;
        }

        .status.checking {
            background: rgba(247, 147, 30, 0.2);
            color: #F7931E;
        }

        .status.success {
            background: rgba(6, 214, 160, 0.2);
            color: #06D6A0;
        }

        .status.error {
            background: rgba(193, 18, 31, 0.2);
            color: #C1121F;
        }

        .error-details {
            background: rgba(193, 18, 31, 0.1);
            border: 1px solid #C1121F;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
        }

        button {
            background: linear-gradient(135deg, #FF6B35, #C1121F);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.4);
        }

        .results {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #06D6A0;
            background: rgba(6, 214, 160, 0.05);
        }

        .log-entry.error {
            border-left-color: #C1121F;
            background: rgba(193, 18, 31, 0.05);
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .info-box {
            background: rgba(6, 214, 160, 0.1);
            border: 1px solid #06D6A0;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .word-level {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }

        .word-level.level-1 {
            background: rgba(6, 214, 160, 0.2);
            color: #06D6A0;
        }

        .word-level.level-2 {
            background: rgba(247, 147, 30, 0.2);
            color: #F7931E;
        }

        .word-level.level-3 {
            background: rgba(193, 18, 31, 0.2);
            color: #C1121F;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic de Connexion Supabase</h1>

        <!-- Configuration -->
        <div class="test-section">
            <h2>üìã Configuration actuelle</h2>
            <div class="config-item">
                <span class="config-label">URL Supabase:</span>
                <span class="config-value" id="configUrl">Chargement...</span>
            </div>
            <div class="config-item">
                <span class="config-label">Anon Key:</span>
                <span class="config-value" id="configKey">Chargement...</span>
            </div>
            <div class="info-box">
                <strong>‚ÑπÔ∏è Structure attendue:</strong><br>
                ‚Ä¢ Table <strong>mots</strong>: id, liste, niveau<br>
                ‚Ä¢ Table <strong>scores</strong>: id, pseudo, facile, intermediaire, difficile, created_at
            </div>
        </div>

        <!-- Test de connexion -->
        <div class="test-section">
            <h2>üîå Test de connexion</h2>
            <button onclick="testConnection()">Tester la connexion</button>
            <div id="connectionStatus"></div>
        </div>

        <!-- Test table mots -->
        <div class="test-section">
            <h2>üìö Test table "mots"</h2>
            <button onclick="testMotsTable()">Tester la table mots</button>
            <div id="motsStatus"></div>
        </div>

        <!-- Test table scores -->
        <div class="test-section">
            <h2>üèÜ Test table "scores"</h2>
            <button onclick="testScoresTable()">Tester la table scores</button>
            <div id="scoresStatus"></div>
        </div>

        <!-- Test complet -->
        <div class="test-section">
            <h2>üéØ Test complet du jeu</h2>
            <button onclick="testCompleteGame()">Simuler une partie compl√®te</button>
            <div id="gameStatus"></div>
        </div>

        <!-- Logs -->
        <div class="test-section">
            <h2>üìù Logs d√©taill√©s</h2>
            <div class="results" id="logs"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // REMPLACE CES VALEURS PAR TES VRAIES CL√âS SUPABASE
        const SUPABASE_URL = 'https://rntiiwtohwzsyzxnicxt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudGlpd3RvaHd6c3l6eG5pY3h0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3ODM3MjgsImV4cCI6MjA4NTM1OTcyOH0.NV9KXoOnfnyKAqrZ4T_wc6g5D_Uh0p140UcsdBQ-ATs';

        // Initialisation
        const { createClient } = supabase;
        let supabaseClient;

        // Afficher la configuration
        document.getElementById('configUrl').textContent = SUPABASE_URL;
        document.getElementById('configKey').textContent = SUPABASE_ANON_KEY.substring(0, 20) + '...';

        function log(message, isError = false) {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry' + (isError ? ' error' : '');
            entry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logsDiv.insertBefore(entry, logsDiv.firstChild);
        }

        async function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = '<div class="status checking">‚è≥ Test en cours...</div>';
            log('D√©but du test de connexion');

            try {
                // Essayer de cr√©er le client
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('‚úÖ Client Supabase cr√©√©');

                // Tester une requ√™te simple
                const { data, error } = await supabaseClient
                    .from('mots')
                    .select('id')
                    .limit(1);

                if (error) {
                    throw error;
                }

                statusDiv.innerHTML = '<div class="status success">‚úÖ Connexion r√©ussie !</div>';
                log('‚úÖ Connexion √† Supabase r√©ussie !');
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">‚ùå Erreur de connexion</div>
                    <div class="error-details">
                        <strong>Code:</strong> ${error.code || 'N/A'}<br>
                        <strong>Message:</strong> ${error.message}<br>
                        <strong>D√©tails:</strong> ${error.details || 'N/A'}<br>
                        <strong>Hint:</strong> ${error.hint || 'V√©rifiez vos cl√©s API'}
                    </div>
                `;
                log(`‚ùå Erreur: ${error.message}`, true);
                console.error('Erreur compl√®te:', error);
            }
        }

        async function testMotsTable() {
            const statusDiv = document.getElementById('motsStatus');
            statusDiv.innerHTML = '<div class="status checking">‚è≥ Test en cours...</div>';
            log('Test de la table "mots"');

            try {
                if (!supabaseClient) {
                    throw new Error('Client Supabase non initialis√©. Testez d\'abord la connexion.');
                }

                // Test 1: Compter les lignes
                const { count, error: countError } = await supabaseClient
                    .from('mots')
                    .select('*', { count: 'exact', head: true });

                if (countError) throw countError;
                log(`‚úÖ Table "mots" trouv√©e avec ${count} entr√©e(s)`);

                // Test 2: R√©cup√©rer tous les mots avec leur niveau
                const { data, error } = await supabaseClient
                    .from('mots')
                    .select('id, liste, niveau')
                    .order('niveau', { ascending: true });

                if (error) throw error;

                let resultsHTML = '<div class="results"><strong>Contenu de la table "mots":</strong><br><br>';
                
                data.forEach(row => {
                    const levelClass = `level-${row.niveau}`;
                    const levelName = row.niveau === 1 ? 'Facile' : row.niveau === 2 ? 'Interm√©diaire' : 'Difficile';
                    const words = row.liste.split(',').slice(0, 5).join(', ') + (row.liste.split(',').length > 5 ? '...' : '');
                    
                    resultsHTML += `
                        <div style="margin-bottom: 1rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 4px;">
                            <strong>ID ${row.id}</strong>
                            <span class="word-level ${levelClass}">${levelName} (niveau ${row.niveau})</span><br>
                            <small>${words}</small>
                        </div>
                    `;
                });
                
                resultsHTML += '</div>';

                statusDiv.innerHTML = `
                    <div class="status success">‚úÖ Table "mots" accessible</div>
                    ${resultsHTML}
                `;
                log(`‚úÖ ${data.length} ligne(s) de mots r√©cup√©r√©e(s) avec succ√®s`);

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">‚ùå Erreur table "mots"</div>
                    <div class="error-details">
                        <strong>Message:</strong> ${error.message}<br>
                        <strong>Code:</strong> ${error.code || 'N/A'}<br>
                        <strong>Hint:</strong> ${error.hint || 'V√©rifiez que les colonnes "id", "liste" et "niveau" existent'}
                    </div>
                `;
                log(`‚ùå Erreur table "mots": ${error.message}`, true);
                console.error('Erreur compl√®te:', error);
            }
        }

        async function testScoresTable() {
            const statusDiv = document.getElementById('scoresStatus');
            statusDiv.innerHTML = '<div class="status checking">‚è≥ Test en cours...</div>';
            log('Test de la table "scores"');

            try {
                if (!supabaseClient) {
                    throw new Error('Client Supabase non initialis√©. Testez d\'abord la connexion.');
                }

                // Test 1: Compter les lignes
                const { count, error: countError } = await supabaseClient
                    .from('scores')
                    .select('*', { count: 'exact', head: true });

                if (countError) throw countError;
                log(`‚úÖ Table "scores" trouv√©e avec ${count} entr√©e(s)`);

                // Test 2: R√©cup√©rer quelques scores
                const { data, error } = await supabaseClient
                    .from('scores')
                    .select('id, pseudo, facile, intermediaire, difficile')
                    .limit(5);

                if (error) throw error;

                let resultsHTML = '<div class="results">';
                resultsHTML += `<strong>Nombre de joueurs:</strong> ${count}<br><br>`;
                
                if (data.length > 0) {
                    resultsHTML += '<strong>Joueurs:</strong><br>';
                    data.forEach(player => {
                        resultsHTML += `
                            <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                <strong>${player.pseudo}</strong><br>
                                <small>
                                    Facile: ${player.facile} | 
                                    Interm√©diaire: ${player.intermediaire} | 
                                    Difficile: ${player.difficile}
                                </small>
                            </div>
                        `;
                    });
                } else {
                    resultsHTML += '<em>Aucun joueur enregistr√© pour le moment</em>';
                }
                
                resultsHTML += '</div>';

                statusDiv.innerHTML = `
                    <div class="status success">‚úÖ Table "scores" accessible</div>
                    ${resultsHTML}
                `;
                log(`‚úÖ ${data.length} score(s) r√©cup√©r√©(s) avec succ√®s`);

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">‚ùå Erreur table "scores"</div>
                    <div class="error-details">
                        <strong>Message:</strong> ${error.message}<br>
                        <strong>Code:</strong> ${error.code || 'N/A'}<br>
                        <strong>Hint:</strong> ${error.hint || 'V√©rifiez que les colonnes "pseudo", "facile", "intermediaire", "difficile" existent'}
                    </div>
                `;
                log(`‚ùå Erreur table "scores": ${error.message}`, true);
                console.error('Erreur compl√®te:', error);
            }
        }

        async function testCompleteGame() {
            const statusDiv = document.getElementById('gameStatus');
            statusDiv.innerHTML = '<div class="status checking">‚è≥ Simulation en cours...</div>';
            log('D√©but de la simulation d\'une partie compl√®te');

            try {
                if (!supabaseClient) {
                    throw new Error('Client Supabase non initialis√©. Testez d\'abord la connexion.');
                }

                const testPseudo = `Test_${Date.now()}`;
                let resultsHTML = '<div class="results">';

                // √âtape 1: Cr√©er un joueur
                log(`Cr√©ation du joueur "${testPseudo}"`);
                const { data: newPlayer, error: insertError } = await supabaseClient
                    .from('scores')
                    .insert([
                        { 
                            pseudo: testPseudo, 
                            facile: 0, 
                            intermediaire: 0, 
                            difficile: 0 
                        }
                    ])
                    .select()
                    .single();

                if (insertError) throw insertError;
                log(`‚úÖ Joueur "${testPseudo}" cr√©√© avec succ√®s`);
                resultsHTML += `‚úÖ Joueur cr√©√©: <strong>${testPseudo}</strong><br><br>`;

                // √âtape 2: Charger des mots (niveau 1)
                log('Chargement des mots niveau 1');
                const { data: motsData, error: motsError } = await supabaseClient
                    .from('mots')
                    .select('liste')
                    .eq('niveau', 1)
                    .single();

                if (motsError) throw motsError;
                const words = motsData.liste.split(',').map(w => w.trim());
                log(`‚úÖ ${words.length} mots charg√©s pour le niveau 1`);
                resultsHTML += `‚úÖ Mots charg√©s: ${words.slice(0, 5).join(', ')}...<br><br>`;

                // √âtape 3: Simuler un score
                const testScore = 250;
                log(`Enregistrement d'un score de ${testScore} points`);
                const { data: updateData, error: updateError } = await supabaseClient
                    .from('scores')
                    .update({ facile: testScore })
                    .eq('pseudo', testPseudo)
                    .select();

                if (updateError) throw updateError;
                log(`‚úÖ Score enregistr√©: ${testScore} points`);
                resultsHTML += `‚úÖ Score enregistr√©: <strong>${testScore} points</strong><br><br>`;

                // √âtape 4: V√©rifier le score
                const { data: verifyData, error: verifyError } = await supabaseClient
                    .from('scores')
                    .select('pseudo, facile, intermediaire, difficile')
                    .eq('pseudo', testPseudo)
                    .single();

                if (verifyError) throw verifyError;
                log(`‚úÖ Score v√©rifi√©: ${verifyData.facile} points`);
                resultsHTML += `
                    ‚úÖ V√©rification r√©ussie:<br>
                    <pre>${JSON.stringify(verifyData, null, 2)}</pre><br>
                `;

                // √âtape 5: Nettoyer (supprimer le joueur test)
                const { error: deleteError } = await supabaseClient
                    .from('scores')
                    .delete()
                    .eq('pseudo', testPseudo);

                if (deleteError) throw deleteError;
                log(`‚úÖ Joueur test supprim√©`);
                resultsHTML += `‚úÖ Joueur test supprim√© (nettoyage)<br>`;

                resultsHTML += '</div>';

                statusDiv.innerHTML = `
                    <div class="status success">‚úÖ Test complet r√©ussi !</div>
                    ${resultsHTML}
                    <div class="info-box">
                        <strong>üéâ Toutes les fonctionnalit√©s fonctionnent correctement !</strong><br>
                        Vous pouvez utiliser votre jeu en toute confiance.
                    </div>
                `;
                log('‚úÖ Simulation compl√®te termin√©e avec succ√®s');

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">‚ùå Erreur lors de la simulation</div>
                    <div class="error-details">
                        <strong>Message:</strong> ${error.message}<br>
                        <strong>Code:</strong> ${error.code || 'N/A'}<br>
                        <strong>√âtape:</strong> ${error.hint || 'Voir les logs pour plus de d√©tails'}
                    </div>
                `;
                log(`‚ùå Erreur lors de la simulation: ${error.message}`, true);
                console.error('Erreur compl√®te:', error);
            }
        }

        // Auto-test au chargement
        window.addEventListener('load', () => {
            log('Page de diagnostic charg√©e');
            log('Structure attendue: Table mots (id, liste, niveau) | Table scores (id, pseudo, facile, intermediaire, difficile)');
            setTimeout(testConnection, 500);
        });
    </script>
</body>
</html>
